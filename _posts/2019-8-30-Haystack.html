<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>elasticsearch</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="styles.css" type="text/css" />
</head>
<body>nmap reveals ports 22, 80 and 9200<br /><img src="{{site.baseurl}}/assets/images/haystack/6-1.png" alt="{{site.baseurl}}/assets/images/haystack/6-1.png" /><br /><br /><br />using strings, we find steg data in image on port 80, a base64 string<br /><img src="{{site.baseurl}}/assets/images/haystack/6-2.png" alt="{{site.baseurl}}/assets/images/haystack/6-2.png" /><br /><br />"bGEgYWd1amEgZW4gZWwgcGFqYXIgZXMgImNsYXZlIg==" on decoding it, we get: "la aguja en el pajar es ‘clave’"<br /><br />elasticsearch is running on port 9200<br />running gobuster on port 9200 reveals index "quotes", “banking” and “.kibana”. while other two are not particularly useful, quotes turns out to be interesting<br />use elasticdump tool to dump the json dB<br />elasticdump --input=http://10.10.10.115:9200/quotes --output=path/to/output<br /><br />grep the output file for "clave" (spanish for "key" which was found in the image  on port 80)<br />this reveals two base64 strings which on decoding give ssh credentials for user<br /><img src="{{site.baseurl}}/assets/images/haystack/6-3.png" alt="{{site.baseurl}}/assets/images/haystack/6-3.png" /><br /><br />run standard enum scripts, and it seems there is an openport on the machines localhost:5601 (run netstat and you will see)<br /><img src="{{site.baseurl}}/assets/images/haystack/6-4.png" alt="{{site.baseurl}}/assets/images/haystack/6-4.png" /><br />version 6.4.2 quick google, and theres a LFI we can exploit. <a href="https://github.com/mpgn/CVE-2018-17246">https://github.com/mpgn/CVE-2018-17246</a><br />i placed a a js reverse shell in tmp, triggered it with LFI and git my shell as kibana<br /><br />theres three config files<br /><img src="{{site.baseurl}}/assets/images/haystack/6-5.png" alt="{{site.baseurl}}/assets/images/haystack/6-5.png" /><br /><br /><br /><img src="{{site.baseurl}}/assets/images/haystack/6-6.png" alt="{{site.baseurl}}/assets/images/haystack/6-6.png" /><img src="{{site.baseurl}}/assets/images/haystack/6-7.png" alt="{{site.baseurl}}/assets/images/haystack/6-7.png" /><img src="{{site.baseurl}}/assets/images/haystack/6-8.png" alt="{{site.baseurl}}/assets/images/haystack/6-8.png" /><br /><br />so whats happening is root runs logstash every 10 seconds, picking up input from /opt/kibana, makes sure it matches the format specified in filter.conf and if everything checks out it executes the command given as input<br /><br />i placed my script in /opt/kibana to copy the root flag to a file in /tmp. or you could ask it to give you a reverse shell? depends on what you would like, i just needed the flag here<br /><br /> </body></html>